---
title: "ChIP-seq analysis workflow with gVenn using A549 datasets: identifying binding site overlaps"
subtitle: "Supplementary data S1"
output-file: "supp_data_S1"
format:
  html:
    toc: true
    toc-depth: 2
    toc-location: left
    number-sections: true
    code-fold: false
    code-tools: true
    code-block-bg: true
    code-block-border-left: "#047857"
    theme: 
      - journal
      - custom.scss
    embed-resources: true
    fig-width: 7
    fig-height: 5
    fig-align: center
    include-in-header:
      - text: |
            <script async src="https://www.googletagmanager.com/gtag/js?id=G-4389F94LTN"></script>
      - text: |
           <script>
              window.dataLayer = window.dataLayer || [];
              function gtag(){dataLayer.push(arguments);}
              gtag('js', new Date());
              gtag('config', 'G-4389F94LTN');
            </script>
execute:
  echo: true
  warning: false
  message: false
---

::: {.callout-note icon=false}
## Interactive notebook
This analysis workflow is available online at:  
**<https://ckntav.github.io/gVenn_manuscript/supp_data_S1.html>**
:::

<p align="center">
<img src="img/gVenn_hex_sticker.png" width="150"/>
</p>

# Overview

This supplementary material demonstrates a complete ChIP-seq analysis workflow using the **gVenn** R package with A549 cell line data. The workflow includes:

- Loading ChIP-seq peak data
- Computing overlaps between genomic regions
- Visualizing results with Venn diagrams and UpSet plots
- Extracting specific overlap groups for downstream analysis
- Exporting results

# Installation

The gVenn package is available through Bioconductor and GitHub.

You can install it from Bioconductor using:

```{r}
#| label: installation-bioconductor
#| eval: false

# From Bioconductor
if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("gVenn")
```

To install the development version from GitHub, use:

```{r}
#| label: installation-github
#| eval: false

# install.packages("pak")  # if not already installed
pak::pak("ckntav/gVenn")

# or, alternatively:
# install.packages("devtools")  # if not already installed
devtools::install_github("ckntav/gVenn")
```

# Load required packages

```{r}
#| label: setup

library(gVenn)
library(GenomicRanges)
library(knitr)
library(tidyverse)
library(kableExtra)
```

## Checking gVenn version

```{r}
#| label: package-version

packageVersion("gVenn")
```

# Dataset description

The dataset consists of ChIP-seq peaks from A549 cells (lung adenocarcinoma cell line) after dexamethasone treatment for two transcriptional coregulators and a transcription factor:

- **MED1**: Mediator complex subunit 1
- **BRD4**: Bromodomain-containing protein 4
- **GR**: Glucocorticoid receptor

These data represent binding sites identified from ChIP-seq experiments.
To keep the dataset small and suitable for examples and tests, each set has been
restricted to peaks located on *chromosome 7*.

The data originate from Tav *et al.* (2023)
(<a href="https://doi.org/10.3389/fgene.2023.1237092" target="_blank">doi:10.3389/fgene.2023.1237092</a>).

# Load ChIP-seq data

The **gVenn** package includes example ChIP-seq peak data for the A549 cell line.

## Locate data files

First, we locate the BED files included in the package:

```{r}
#| label: locate-file

# Locate the gzipped BED files inside inst/extdata/ of the installed package
bed_med1 <- system.file("extdata", "A549_MED1_Dex.stdchr.bed.gz", package = "gVenn")
bed_brd4 <- system.file("extdata", "A549_BRD4_Dex.stdchr.bed.gz", package = "gVenn")
bed_gr   <- system.file("extdata", "A549_GR_Dex.stdchr.bed.gz", package = "gVenn")
```

## Import peak data

Next, we import the peak sets using `rtracklayer`:

```{r}
#| label: import-peaks

# Import full consensus peak sets
med1_full <- rtracklayer::import(bed_med1)
brd4_full <- rtracklayer::import(bed_brd4)
gr_full   <- rtracklayer::import(bed_gr)
```

## Filter to chromosome 7

To keep the dataset small and suitable for examples, we restrict the analysis to peaks on chromosome 7:

```{r}
#| label: filter-chr7

# Helper function: keep only peaks on chr7
keep_chr7 <- function(gr) {
    gr[seqnames(gr) %in% c("chr7", "7")]
}

# Subset each peak set to chr7 only (keeps the dataset small and fast for examples)
med1_chr7 <- keep_chr7(med1_full)
brd4_chr7 <- keep_chr7(brd4_full)
gr_chr7 <- keep_chr7(gr_full)
```

## Create GRangesList object

Finally, we combine the filtered peak sets into a single `GRangesList` object:

```{r}
#| label: create-grangeslist

# Combine into a GRangesList with descriptive names
a549_chipseq_peaks <- GRangesList("MED1_Dex_chr7" = med1_chr7,
                                  "BRD4_Dex_chr7" = brd4_chr7,
                                  "GR_Dex_chr7" = gr_chr7)

# Display the structure of the dataset
a549_chipseq_peaks
```

## Dataset summary

```{r}
#| label: dataset-summary

# Create a summary table
summary_df <- data.frame(
  "factor" = gsub("_Dex_chr7", "", names(a549_chipseq_peaks)),
  "number of peaks" = sapply(a549_chipseq_peaks, length),
  check.names = FALSE
)

kable(summary_df, 
      caption = "Summary of ChIP-seq peaks for each factor")
```

# Computing overlaps

The `computeOverlaps()` function analyzes the intersection patterns across all peak sets. For genomic ranges, it identifies regions that overlap between different ChIP-seq samples:

```{r}
#| label: compute-overlaps

# Compute overlaps between ChIP-seq peaks
genomic_overlaps <- computeOverlaps(a549_chipseq_peaks)

# Display the structure of the result
class(genomic_overlaps)
names(genomic_overlaps)
```

# Visualization

## Venn diagram

The `plotVenn()` function creates area-proportional Venn diagrams to visualize the overlaps between ChIP-seq peaks:

```{r}
#| label: fig-venn-basic
#| fig-cap: "Basic Venn diagram showing overlaps between ChIP-seq peaks"
#| fig-width: 7
#| fig-height: 5

# Create a basic Venn diagram
plotVenn(genomic_overlaps)
```

## UpSet plot

For complex overlap patterns, `plotUpSet()` provide an alternative visualization that can be easier to interpret with more than 4 sets:

```{r}
#| label: fig-upset
#| fig-cap: "UpSet plot showing intersection sizes between ChIP-seq peaks"
#| fig-width: 6
#| fig-height: 3

# Create an UpSet plot
plotUpSet(genomic_overlaps,
          comb_col = c( "#D87093",  "#CD3301", "#9370DB", "#008B8B", "#2B70AB", "#FFB027", "#3EA742"))
```

The top bar chart shows intersection sizes for each overlap combination, while the connected dots below indicate which sets participate in each intersection. Horizontal bars on the right show total set sizes. The UpSet representation is particularly useful for comparing more than four sets or when precise quantification of complex overlap patterns is required.

# Extracting Overlap Groups

The `extractOverlaps()` function extracts the actual genomic regions for each overlap group, which can be useful for downstream analyses such as:

- Motif enrichment analysis
- Peak annotation to nearby genes
- Functional enrichment analysis
- Export for genome browsers

```{r}
#| label: extract-groups

# Extract all overlap groups
overlap_groups <- extractOverlaps(genomic_overlaps)

# Display the number of peaks in each group
group_sizes <- sapply(overlap_groups, length)
group_df <- data.frame(
  "Group" = names(group_sizes),
  "Number of Peaks" = group_sizes,
  check.names = FALSE
)

kable(group_df,
      caption = "Number of genomic regions in each overlap group",
      row.names = FALSE)
```

## Example: Peaks Shared by All Three Factors

Let's examine the peaks that are bound by all three transcription factors (MED1, BRD4, and GR):

```{r}
#| label: shared-peaks

# Extract peaks present in all three sets (group_111)
shared_peaks <- overlap_groups[["group_111"]]

# Display information about these shared peaks
cat("Number of peaks bound by all three factors:", length(shared_peaks), "\n\n")

# Show the first 10 shared peaks
head(shared_peaks, 10)
```

## Example: Factor-Specific Peaks

We can also extract peaks unique to each factor:

```{r}
#| label: unique-peaks

# Extract factor-specific peaks
med1_specific <- overlap_groups[["group_100"]]
brd4_specific <- overlap_groups[["group_010"]]
gr_specific <- overlap_groups[["group_001"]]

# Summary
unique_peaks_df <- data.frame(
  "Factor" = c("MED1", "BRD4", "GR"),
  "Unique Peaks" = c(length(med1_specific), 
                     length(brd4_specific), 
                     length(gr_specific)),
  check.names = FALSE
)

kable(unique_peaks_df,
      caption = "Number of factor-specific peaks",
      row.names = FALSE)
```

## Example: Pairwise Overlaps

Extract peaks shared between pairs of factors:

```{r}
#| label: pairwise-peaks

# Extract pairwise overlaps
med1_brd4 <- overlap_groups[["group_110"]]  # MED1 and BRD4, not GR
med1_gr <- overlap_groups[["group_101"]]    # MED1 and GR, not BRD4
brd4_gr <- overlap_groups[["group_011"]]    # BRD4 and GR, not MED1

# Summary
pairwise_df <- data.frame(
  "Overlap" = c("MED1 ∩ BRD4", "MED1 ∩ GR", "BRD4 ∩ GR"),
  "Number of Peaks" = c(length(med1_brd4), 
                        length(med1_gr), 
                        length(brd4_gr)),
  check.names = FALSE
)

kable(pairwise_df,
      caption = "Number of peaks in pairwise overlaps (excluding triple overlap)",
      row.names = FALSE)
```

# Export Results

## Export Peak Coordinates

The extracted overlap groups can be exported as BED files for visualization in genome browsers or for downstream analysis:

```{r}
#| label: export-bed
#| eval: false

# Export shared peaks to BED format
library(rtracklayer)

# Export peaks shared by all three factors
export.bed(shared_peaks, "output/peaks_all_three_factors.bed")

# Export MED1-specific peaks
export.bed(med1_specific, "output/peaks_MED1_specific.bed")

# Export BRD4-specific peaks
export.bed(brd4_specific, "output/peaks_BRD4_specific.bed")

# Export GR-specific peaks
export.bed(gr_specific, "output/peaks_GR_specific.bed")
```

## Export Summary Table

Create a comprehensive summary table:

```{r}
#| label: export-summary

# Create a detailed summary
all_groups <- names(overlap_groups)
summary_table <- data.frame(
  Group = all_groups,
  Pattern = all_groups,
  Count = sapply(overlap_groups, length),
  Percentage = round(100 * sapply(overlap_groups, length) / 
                     sum(sapply(overlap_groups, length)), 2)
)

# Add interpretation
summary_table$Interpretation <- c(
  "MED1 only",
  "BRD4 only", 
  "GR only",
  "MED1 ∩ BRD4",
  "BRD4 ∩ GR",
  "MED1 ∩ GR",
  "All three factors"
)

kable(summary_table,
      caption = "Complete summary of ChIP-seq peak overlaps",
      row.names = FALSE)
```

# Biological Interpretation

The overlap analysis reveals important insights about transcription factor co-binding:

1. **Core co-regulatory regions**: The `r length(shared_peaks)` peaks shared by all three factors likely represent core regulatory elements where MED1, BRD4, and GR work together.

2. **Factor-specific binding**: Each transcription factor also has unique binding sites, suggesting independent regulatory functions.

3. **Pairwise cooperativity**: The pairwise overlaps indicate potential cooperative binding between pairs of factors.

# Session Information

```{r}
#| label: session-info

sessionInfo()
```

# References

For more information about the gVenn package, visit:

- Package documentation: [https://ckntav.github.io/gVenn/](https://ckntav.github.io/gVenn/)
- GitHub repository: [https://github.com/ckntav/gVenn](https://github.com/ckntav/gVenn)
